<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
    
    <head>
        <title>Sketch Widget</title>
        <meta http-equiv="content-type" content="text/html;charset=utf-8" />
    
        <link rel="stylesheet" type="text/css" href="/common/ui/melange.css" media="screen" />

        <script type="text/javascript" src="/common/core/mootools.js" />
        <script type="text/javascript" src="/common/core/mootools-more.js" />
        <script type="text/javascript" src="/common/core/cream.js" />

        <script language="javascript">
            function main() {
                canvas = document.getElementById('canvas')
                ctx = canvas.getContext('2d');

                $('save').addEvent('click', function() {
                    widget.api.sketch.save_image(canvas.toDataURL());
                });


                function paint(type, x, y) {
                    switch (type) {
                        case 'mousedown':
                            mousedown(x, y);
                            break;
                        case 'mousemove':
                            mousemove(x, y);
                            break;
                        case 'mouseup':
                            mouseup(x, y);  
                    }
                    function mousedown(x, y) {
                        ctx.beginPath();
                        ctx.moveTo(x, y);
                        this.active = true;
                        
                    };
                    function mousemove(x, y) {
                        if (this.active) {
                            tool = $('tool').value;
                            if (tool == 'pencil') {
                                ctx.lineTo(x, y);
                                ctx.stroke();
                            } else if (tool == 'eraser') {
                                ctx.fillStyle = 'white';
                                ctx.rect(x, y, 10, 10);
                                ctx.fill();
                            }                             
                        }
                    };
                    function mouseup(x, y) {
                        if (this.active) {
                            mousemove(x, y);
                            this.active = false;
                        }
                    };
                    
                };

                function event_handler(event) {
                    x = event.layerX - 15; 
                    y = event.layerY - 15;

                    paint(event.type, x, y);
                };

                canvas.addEventListener('mousedown', event_handler, false);
                canvas.addEventListener('mousemove', event_handler, false);
                canvas.addEventListener('mouseup', event_handler, false);

                //set background-color to white
                ctx.fillStyle = 'rgb(255, 255, 255)'
                ctx.fillRect(0,0,canvas.width, canvas.height);
            };
        </script>
        <style type="text/css">
            canvas {
                margin-top: 10px;
                margin-left: 10px;
            }
        </style>

    </head>
    
    <body>
        <div class="widget" style="width: 316px; height: 293px;">
            <div style="width: 306px; height: 283px; background-image: url(paper.png);">
                <canvas id="canvas" width="280" height="260"></canvas>
            </div>
            <select id="tool">
                <option value="pencil">Pencil</option>
                <option value="eraser">Eraser</option>
            </select>
            <div class="button" id="save">Save</div>
        </div>
    </body>
</html>
